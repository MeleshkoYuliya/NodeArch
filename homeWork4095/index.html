<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="index.css" />
  </head>
  <body>
    <div class="mainContainer" id="mainContainer">
      <div class="requestsContainer">
        <div></div>
      </div>
      <form class="formContainer" method="POST" name="methodConfig" novalidate>
        <div class="formRow">
          <div class="formElement">
            <select
              class="input"
              name="method"
              id="method"
              onchange="onSelectChange(this)"
            >
              <option value="GET">GET</option>
              <option value="POST">POST</option>
              <option value="PUT">PUT</option>
            </select>
            <label class="label" for="method"> Метод </label>
          </div>
          <div class="formElement">
            <input class="input" name="url" />
            <label class="label"> URL </label>
          </div>
        </div>
        <div id="body"></div>
        <div id="parametrs" class="parametrs"></div>
        <button class="textButton" type="button" onclick="handleAddParamsRow()">
          Добавить параметр
        </button>
        <hr class="divider" />
        <div id="headers" class="parametrs"></div>
        <button
          class="textButton"
          id="addHeaderRowBtn"
          onclick="handleAddHeaderRow()"
          type="button"
        >
          Добавить заголовок
        </button>
        <hr class="divider" />
        <div class="buttonsContainer">
          <button
            class="actionButton"
            onclick="handleMethodSave()"
            type="button"
          >
            Сохранить запрос
          </button>
          <button class="actionButton">Отправить запрос</button>
          <button class="actionButton">Очистить форму</button>
        </div>
      </form>
    </div>

    <script async>
      let parametrs = [];
      let headers = [];

      const headersOptions = [
        "Content-type",
        "Origin",
        "Accept",
        "Cache-Control",
        "Access-Control-Allow-Origin",
        "Access-Control-Allow-Headers",
      ];

      function onSelectChange(event) {
        const value = event.value;
        const bodyInput = document.getElementById("bodyInput");
        const container = document.getElementById("body");

        if ((value === "POST" || value === "PUT") && !bodyInput) {
          const title = document.createElement("h3");
          title.setAttribute("id", "headersTitle");
          container.appendChild(title).innerHTML = "Тело Запроса";
          const textArea = document.createElement("textarea");
          textArea.setAttribute("name", "bodyInput");
          textArea.setAttribute("id", "bodyInput");
          container.appendChild(textArea);
        }

        if (value === "GET" && bodyInput) {
          container.innerHTML = ``;
        }
      }

      function handleGetFormData() {
        const formTag = document.forms.methodConfig;
        const bodyInput = formTag.elements.bodyInput;

        const headerValues =
          formTag.elements.headerValue && formTag.elements.headerValue.length
            ? Array.from(formTag.elements.headerValue).map((item) => item.value)
            : formTag.elements.headerValue
            ? [formTag.elements.headerValue.value]
            : [];

        const headerNames =
          formTag.elements.headerName &&
          formTag.elements.headerName.length &&
          !formTag.elements.headerName?.value
            ? Array.from(formTag.elements.headerName).map((item) => item.value)
            : formTag.elements.headerName
            ? [formTag.elements.headerName.value]
            : [];

        const paramValues =
          formTag.elements.paramValue && formTag.elements.paramValue.length
            ? Array.from(formTag.elements.paramValue).map((item) => item.value)
            : formTag.elements.paramValue
            ? [formTag.elements.paramValue.value]
            : [];

        const paramNames =
          formTag.elements.paramName && formTag.elements.paramName.length
            ? Array.from(formTag.elements.paramName).map((item) => item.value)
            : formTag.elements.paramName
            ? [formTag.elements.paramName.value]
            : [];

        const headersData = headerNames.reduce((acc, item, index) => {
          return { ...acc, [item]: headerValues[index] };
        }, {});

        const paramsData = paramNames.reduce((acc, item, index) => {
          return { ...acc, [item]: paramValues[index] };
        }, {});

        const values = {
          url: formTag.elements.url.value,
          method: formTag.elements.method.value,
          body: bodyInput ? bodyInput.value : "",
          headers: headersData,
          params: paramsData,
        };

        return values;
      }

      function handleMethodSave(EO) {
        EO = EO || window.event;

        const formValues = handleGetFormData();
        console.log(formValues)
      }

      function handleAddParamsRow() {
        const newId = parametrs.length
          ? parametrs[parametrs.length - 1].id + 1
          : 1;
        parametrs.push({ id: newId });
        const container = document.getElementById("parametrs");

        const datarow = `
          <input class="input" name="paramName" />
          <input class="input" name="paramValue" />
          <button class="textButton" type="button" onclick="handleDeleteParamRow(${newId})">
            Удалить
          </button>
        `;

        if (parametrs.length === 1) {
          const title = document.createElement("h3");
          title.setAttribute("id", "parametrsTitle");
          container.appendChild(title).innerHTML = "Параметры";
        }
        const content = container.innerHTML;
        const node = document.createElement("div");
        node.setAttribute("id", `parametr-${newId}`);
        node.classList.add("paramRow");
        node.innerHTML = datarow;
        container.appendChild(node);
      }

      function handleDeleteParamRow(id) {
        const container = document.getElementById("parametrs");
        const element = document.getElementById(`parametr-${id}`);
        container.removeChild(element);
        parametrs = parametrs.filter((item) => item.id !== id);
        if (!parametrs.length) {
          const title = document.getElementById("parametrsTitle");
          container.removeChild(title);
        }
      }

      function handleAddHeaderRow() {
        const newId = headers.length ? headers[headers.length - 1].id + 1 : 1;
        headers = [...headers, { id: newId }];

        if (headers.length === 6) {
          const btn = document.getElementById("addHeaderRowBtn");
          btn.classList.add("hidden");
        }

        const container = document.getElementById("headers");

        if (headers.length === 1) {
          const title = document.createElement("h3");
          title.setAttribute("id", "headersTitle");
          container.appendChild(title).innerHTML = "Заголовки";
        }

        const datarow = `
          <select class="input" name="headerName" id="headerName">
            ${headersOptions.map(
              (item) => `<option value="${item}">${item}</option>`
            )}
          </select>
          <input class="input" name="headerValue" />
          <button class="textButton" type="button" onclick="handleDeleteHeaderRow(${newId})">
            Удалить
          </button>
        `;

        const content = container.innerHTML;
        const node = document.createElement("div");
        node.setAttribute("id", `header-${newId}`);
        node.classList.add("paramRow");
        node.innerHTML = datarow;
        container.appendChild(node);
      }

      function handleDeleteHeaderRow(id) {
        const container = document.getElementById("headers");

        headers = headers.filter((item) => item.id !== id);

        if (headers.length === 5) {
          const btn = document.getElementById("addHeaderRowBtn");
          btn.classList.remove("hidden");
        }

        if (!headers.length) {
          const title = document.getElementById("headersTitle");
          container.removeChild(title);
        }

        const element = document.getElementById(`header-${id}`);
        container.removeChild(element);
      }
    </script>
  </body>
</html>
