<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      .mainContainer {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
      }

      .button {
        border: none;
        border-radius: 4px;
        font-size: 18px;
        font-weight: 600;
        padding: 6px 18px;
        width: 200px;
        cursor: pointer;
        text-align: center;
        position: relative;
        background-color: #fff;
        box-sizing: border-box;
      }
      .green {
        border: solid 2px green;
      }
      .yellow {
        border: solid 2px yellow;
      }
      .red {
        border: solid 2px red;
      }
      .pink {
        border: solid 2px pink;
      }
      .blue {
        border: solid 2px blue;
      }
      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: center;
      }
      .button input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
      }

      .checkmark {
        position: absolute;
        top: 0;
        bottom: 0;
        margin: auto 0px;
        left: 8px;
        height: 20px;
        width: 20px;
        background-color: #eee;
        border-radius: 50%;
      }

      .button:hover input ~ .checkmark {
        background-color: #ccc;
      }

      .green input:checked ~ .checkmark {
        background-color: green;
      }
      .yellow input:checked ~ .checkmark {
        background-color: yellow;
      }
      .red input:checked ~ .checkmark {
        background-color: red;
      }
      .blue input:checked ~ .checkmark {
        background-color: blue;
      }
      .pink input:checked ~ .checkmark {
        background-color: pink;
      }

      .checkmark:after {
        content: "";
        position: absolute;
        display: none;
      }

      .button input:checked ~ .checkmark:after {
        display: block;
      }

      .button .checkmark:after {
        top: 6px;
        left: 6px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: white;
      }
      .sendButton {
        border: solid 1px black;
        border-radius: 4px;
        font-size: 18px;
        font-weight: 600;
        padding: 6px 18px;
        width: 200px;
        box-sizing: border-box;
        cursor: pointer;
        text-align: center;
        position: relative;
        background-color: #fff;
        margin-top: 24px;
      }

      .stat {
        font-size: 18px;
        text-transform: capitalize;
      }
    </style>
  </head>
  <body>
    <div class="mainContainer">
      <form class="container" name="options" novalidate onsubmit="handleSubmit">
        <h1>Choose your favourite color</h1>
        <div id="container" class="container"></div>
        <input type="submit" value="Send" class="sendButton" />
      </form>
      <div class="container">
        <h1>Statistic</h1>
        <div id="stat" class="container"></div>
      </div>
    </div>

    <script async>
      const colors = [
        { label: "Green", id: "green" },
        { label: "Yellow", id: "yellow" },
        { label: "Blue", id: "blue" },
        { label: "Red", id: "red" },
        { label: "Pink", id: "pink" },
      ];

      function handleGetVariants() {
        fetch("/variants")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            return response.json();
          })
          .then((json) => {
            for (let key in json) {
              if (json.hasOwnProperty(key)) {
                let val = json[key];
                let dataspan = `
                      <input type="radio" name="color" value=${val.id}>
                      ${val.label}
                      <span class="checkmark"></span>
                    `;
                const node = document.createElement("label");
                node.classList.add("button");
                node.classList.add(val.id);
                document
                  .getElementById("container")
                  .appendChild(node).innerHTML = dataspan;
              }
            }
          })
          .catch((err) => console.error(`Fetch problem: ${err.message}`));
      }

      function handleGetStat() {
        fetch("/stat", { method: "POST" })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }

            return response.json();
          })
          .then((json) => {
            for (let key in json) {
              if (json.hasOwnProperty(key)) {
                const val = json[key];
                const currColorLabel = colors.find(
                  (item) => item.id === val.color
                );

                if (val.color) {
                  const dataspan = `
                      <span>${currColorLabel.label}</span>:
                      <span>${val.count}</span>
                    `;
                  const node = document.createElement("div");
                  node.classList.add("stat");
                  node.setAttribute("id", val.color);

                  const oldEl = document.getElementById(val.color);
                  if (oldEl) {
                    document.getElementById("stat").removeChild(oldEl);
                  }
                  document.getElementById("stat").appendChild(node).innerHTML =
                    dataspan;
                }
              }
            }
          })
          .catch((err) => console.error(`Fetch problem: ${err.message}`));
      }

      const formTag = document.forms.options;
      formTag.addEventListener("submit", handleSubmit, false);

      function handleSubmit(EO) {
        EO = EO || window.event;
        EO.preventDefault();
        const formTag = document.forms.options;
        const color = formTag.elements.color.value;

        const params = new URLSearchParams();
        params.append("color", color);

        fetch("/vote", { method: "POST", body: params })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error: ${response.status}`);
            }
            handleGetStat();
          })
          .catch((err) => console.error(`Fetch problem: ${err.message}`));
      }

      handleGetVariants();
      handleGetStat();
    </script>
  </body>
</html>
